<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent - Workspace</title>
    
    <!-- Markdown Parser (Switched to jsDelivr for reliable UMD support) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    
    <!-- HTMX (Optional helper) -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Highlight.js for code coloring -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #efefef;
            --text-primary: #000000;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --accent: #0070f3;
            --sidebar-icon-bar: #fbfbfb;
            --sidebar-bg: #ffffff;
            --chat-bg: #ffffff;
            --message-user: #0070f3;
            --message-assistant: #f0f0f0;
        }

        body.dark-mode {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --border-color: #333333;
            --sidebar-icon-bar: #151515;
            --sidebar-bg: #0a0a0a;
            --chat-bg: #1a1a1a;
            --message-user: #0070f3;
            --message-assistant: #2a2a2a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; z-index: 100;
        }
        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .logo {
            font-size: 1.25rem; font-weight: 600; color: var(--text-primary);
            text-decoration: none; display: flex; align-items: center; gap: 0.5rem;
        }
        .plan-badge {
            font-size: 0.8rem; font-weight: 500;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 0.25rem 0.6rem;
            border-radius: 0.4rem;
        }
        .btn-upgrade {
            font-size: 0.9rem; font-weight: 500; color: var(--accent);
            text-decoration: none;
        }
        .theme-toggle {
            background: none; border: none; font-size: 1.5rem;
            cursor: pointer; color: var(--text-primary);
        }

        /* --- Profile Dropdown --- */
        .profile-area { position: relative; }
        .profile-button {
            width: 32px; height: 32px; border-radius: 50%;
            background-color: var(--accent);
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; cursor: pointer;
            border: 2px solid var(--border-color);
        }
        .profile-dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 10px); right: 0;
            width: 320px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.8rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            z-index: 101;
            padding: 0.5rem;
        }
        .profile-dropdown-menu.visible { display: block; }
        .profile-section { padding: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .profile-section:last-child { border-bottom: none; }
        .profile-email {
            font-size: 0.9rem; font-weight: 500; color: var(--text-primary);
            padding: 0.5rem 0.5rem 1rem 0.5rem; word-break: break-all;
        }
        .profile-menu-list { list-style: none; }
        .profile-menu-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.6rem 0.5rem; border-radius: 0.4rem;
            color: var(--text-primary); text-decoration: none; font-size: 0.9rem;
        }
        .profile-menu-item:hover { background-color: var(--bg-secondary); }
        .profile-menu-item-left { display: flex; align-items: center; gap: 0.75rem; }
        .profile-menu-item svg { width: 20px; height: 20px; color: var(--text-secondary); }
        .credit-balance-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem;
            padding: 0.5rem; font-size: 0.9rem;
        }
        .credit-label { color: var(--text-secondary); }
        .credit-value { text-align: right; font-weight: 500; }
        .profile-upgrade-link {
            font-size: 0.9rem; color: var(--accent); text-decoration: none;
            padding: 0.5rem; display: block;
        }
        .profile-upgrade-link:hover { text-decoration: underline; }

        /* --- Workspace Layout --- */
        .workspace-container {
            display: flex;
            flex-grow: 1; 
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            padding: 1.5rem; gap: 1.5rem;
        }
        .btn-new-chat {
            width: 100%;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem; border-radius: 0.4rem;
            cursor: pointer; font-weight: 500; font-size: 0.95rem;
            color: var(--text-primary); text-align: left;
            transition: background-color 0.2s;
        }
        .btn-new-chat:hover { background-color: var(--border-color); }
        .sidebar-profile-info { margin-bottom: 1rem; }
        .sidebar-profile-name { font-weight: 600; font-size: 0.9rem; }
        .sidebar-profile-plan { font-size: 0.8rem; color: var(--text-secondary); }

        /* Chat Area */
        .chat-area {
            flex: 1; 
            display: flex; 
            flex-direction: column;
            background-color: var(--bg-primary); 
            /* Key fix for scrolling: */
            overflow-y: auto; 
            position: relative;
        }
        
        /* The container for messages inside chat-area */
        .chat-messages {
            flex-grow: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 900px; width: 100%; margin: 0 auto;
            padding-bottom: 100px; /* Space for input area */
        }
        
        .hero-placeholder {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; min-height: 50vh; padding-bottom: 10vh;
        }
        .hero-placeholder h1 { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .hero-placeholder p { font-size: 1.1rem; color: var(--text-secondary); }

        /* Messages */
        .message { display: flex; gap: 1rem; max-width: 100%; }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .message.assistant { align-self: flex-start; }
        
        .message-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: white; flex-shrink: 0;
        }
        .message.user .message-avatar { background-color: var(--accent); }
        .message.assistant .message-avatar { background-color: #667eea; }
        
        .message-content {
            padding: 1rem; border-radius: 0.6rem;
            word-wrap: break-word; 
            /* Fix overflow for code blocks */
            max-width: 100%;
            overflow-x: hidden; 
        }
        
        /* --- CODE BLOCK STYLING (FIXED) --- */
        .message-content pre {
            background-color: #1e1e1e;
            border: 1px solid var(--border-color);
            border-radius: 8px; 
            padding: 1rem; 
            overflow-x: auto; /* Enables horizontal scroll for code */
            font-family: monospace; 
            font-size: 0.9rem;
            color: #e0e0e0;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            white-space: pre; /* Important for code alignment */
        }
        
        .message.user .message-content { background-color: var(--message-user); color: white; }
        /* Fix user message pre blocks to be readable */
        .message.user .message-content pre { background-color: rgba(0,0,0,0.2); border: none; color: white; }
        
        .message.assistant .message-content { background-color: var(--message-assistant); }
        
        .cost-message {
            text-align: center; font-size: 0.75rem;
            color: var(--text-secondary); opacity: 0.7; margin: -0.5rem 0;
        }

        /* Input Area */
        .chat-input-area {
            padding: 1.5rem;
            background-color: var(--bg-primary);
            /* Sticky bottom to overlay scroll content */
            position: sticky; 
            bottom: 0;
            width: 100%;
        }
        .chat-input-wrapper {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.8rem;
            padding: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .chat-input-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1);
        }
        #prompt-form { display: flex; flex-direction: column; gap: 1rem; }
        .chat-input {
            flex: 1; background: none; border: none; outline: none;
            color: var(--text-primary); font-family: inherit; font-size: 1rem;
            resize: none; max-height: 200px;
        }
        .chat-actions {
            display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid var(--border-color); padding-top: 1rem;
        }
        .chat-send-btn {
            background-color: var(--accent); color: white; border: none;
            padding: 0.6rem 1.2rem; border-radius: 0.4rem;
            cursor: pointer; font-weight: 500; transition: opacity 0.2s;
        }
        .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: inline-block; }
        .htmx-request .htmx-indicator-invert { display: none; }

        /* Preview Area */
        .preview-area {
            display: none; /* Hidden by default */
            width: 50%;
            border-left: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            flex-direction: column; 
            height: 100%; /* Full height */
        }
        .preview-header {
            padding: 1rem;
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            width: 100%; font-weight: 600;
            display: flex; justify-content: space-between;
        }
        .preview-iframe {
            width: 100%; height: 100%;
            border: none; background-color: white;
            flex-grow: 1;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .preview-area { 
                position: fixed; top: 60px; right: 0; bottom: 0; left: 0; 
                width: 100%; z-index: 50; 
            }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .header { padding: 0.75rem 1rem; }
            .logo { font-size: 1.25rem; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
    </style>
</head>
<body> 

<header class="header">
    <div class="header-left">
        <a href="{{ url_for('chat_interface') }}" class="logo">AI Agent</a>
        <span class="plan-badge">Free</span>
        <a href="{{ url_for('pricing_page') }}" class="btn-upgrade">Upgrade</a>
    </div>
    
    <div class="header-right">
        <button class="theme-toggle" onclick="toggleTheme(event)">ðŸŒ™</button>
        
        <div class="profile-area">
            <button class="profile-button" id="profile-button">
                {% if current_user and current_user.email %}
                    {{ current_user.email[0]|upper }}
                {% else %}
                    U
                {% endif %}
            </button>
            
            <div class="profile-dropdown-menu" id="profile-dropdown">
                <div class="profile-section">
                    <div class="profile-email">
                        {% if current_user and current_user.email %}
                            {{ current_user.email }}
                        {% else %}
                            user@example.com
                        {% endif %}
                    </div>
                    <!-- Menu items -->
                    <ul class="profile-menu-list">
                         <li><a href="#" class="profile-menu-item"><div class="profile-menu-item-left"><span>Profile</span></div></a></li>
                         <li><a href="{{ url_for('pricing_page') }}" class="profile-menu-item"><div class="profile-menu-item-left"><span>Pricing</span></div></a></li>
                    </ul>
                </div>
                <div class="profile-section">
                    <div class="credit-balance-grid">
                        <span class="credit-label">Credit Balance</span>
                        <span class="credit-value" id="credit-balance-dropdown">
                            {% if user_credits %}
                                {{ "%.2f"|format(user_credits|float) }}
                            {% else %}
                                5.00
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="profile-section">
                    <a href="{{ url_for('logout') }}" class="profile-menu-item">
                        <div class="profile-menu-item-left"><span>Logout</span></div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="workspace-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <button class="new-chat-btn" onclick="window.location.reload()">+ New Chat</button>
        <div class="sidebar-menu">
             <!-- History can be injected here -->
             <div class="sidebar-item-label">Chat History</div>
             <!-- If you have history passed from backend, loop here. For now, empty. -->
        </div>
    </aside>

    <!-- Chat Wrapper -->
    <div class="chat-area" id="chat-area-scrollable">
        <div class="chat-messages" id="chatMessages">
            <div class="hero-placeholder" id="hero-placeholder">
                <h1>Welcome to your AI Agent</h1>
                <p>Start a new conversation by typing below.</p>
            </div>
            <!-- Messages go here -->
        </div>
        
        <div class="chat-input-area">
            <div class="chat-input-wrapper">
                <form id="prompt-form">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="Ask v0 to build..."
                        oninput="autoResize(this)"
                        onkeydown="handleChatKeypress(event)"
                    ></textarea>
                    
                    <div class="chat-actions">
                        <div class="chat-tools">
                            <!-- Upload button visual only for now -->
                            <label class="tool-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg></label>
                        </div>
                        <button type="submit" class="chat-send-btn" id="submit-button">
                            <span class="htmx-indicator">...</span>
                            <span class="htmx-indicator-invert">Send</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div> 

    <!-- Preview Area -->
    <div class="preview-area" id="preview-area">
        <div class="preview-header">
            <span>Live Preview</span>
            <button onclick="closePreview()" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">Ã—</button>
        </div>
        <iframe id="preview-iframe" class="preview-iframe"></iframe>
    </div>
</div>

<script>
    // --- STATE ---
    const appState = { isLoading: false, hasChatted: false };
    let md; 

    // --- ELEMENTS ---
    const chatMessages = document.getElementById('chatMessages');
    const chatAreaScrollable = document.getElementById('chat-area-scrollable');
    const promptForm = document.getElementById('prompt-form');
    const chatInput = document.getElementById('chatInput');
    const submitButton = document.getElementById('submit-button');
    const creditBalanceEl = document.getElementById('credit-balance-dropdown');
    const heroPlaceholder = document.getElementById('hero-placeholder');
    const previewArea = document.getElementById('preview-area');
    const previewIframe = document.getElementById('preview-iframe');
    const profileButton = document.getElementById('profile-button');
    const profileDropdown = document.getElementById('profile-dropdown');

    // --- MARKDOWN SETUP (Fixing Formatting) ---
    window.addEventListener('load', () => {
        try {
            if (typeof window.markdownit !== 'function') {
                 throw new Error("Markdown-it not loaded correctly");
            }
            md = window.markdownit({
                html: true,
                linkify: true,
                highlight: function (str, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(str, { language: lang }).value;
                        } catch (__) {}
                    }
                    return ''; // use external default escaping
                }
            });
        } catch (e) {
            console.error("Markdown lib error:", e);
            // Fallback simple renderer so chat still works even if markdown fails
            md = { render: (t) => t.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>") }; 
        }
    });

    // --- FUNCTIONS ---

    function autoResize(element) {
        element.style.height = 'auto';
        element.style.height = (element.scrollHeight) + 'px';
    }

    function handleChatKeypress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            promptForm.requestSubmit();
        }
    }

    // FIX SCROLLING: Scroll the parent container, not the message list
    function scrollToBottom() {
        setTimeout(() => {
            if (chatAreaScrollable) {
                chatAreaScrollable.scrollTop = chatAreaScrollable.scrollHeight;
            }
        }, 50);
    }

    function addMessageToChat(role, text, isLoading = false) {
        if (!appState.hasChatted) {
            if (heroPlaceholder) heroPlaceholder.style.display = 'none';
            appState.hasChatted = true;
        }

        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message ${role}`;
        
        let avatarContent = role === 'user' ? 'U' : 'AI';
        let avatarBg = role === 'user' ? 'var(--accent)' : '#667eea';
        
        // Render content
        let contentHtml = '';
        if (isLoading) {
            contentHtml = '<div class="blinking-cursor">...</div>';
        } else if (role === 'assistant' && md) {
            contentHtml = md.render(text);
        } else {
            // User text (safe escape)
            contentHtml = text.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>");
        }

        messageWrapper.innerHTML = `
            <div class="message-avatar" style="background-color: ${avatarBg};">${avatarContent}</div>
            <div class="message-content">${contentHtml}</div>
        `;

        chatMessages.appendChild(messageWrapper);
        scrollToBottom();
        
        return messageWrapper.querySelector('.message-content');
    }

    // FIX PREVIEW: Combine HTML/CSS/JS into one iframe
    function renderPreview(text) {
        // 1. Extract blocks
        const htmlMatch = text.match(/```html\n([\s\S]*?)\n```/);
        const cssMatch = text.match(/```css\n([\s\S]*?)\n```/);
        const jsMatch = text.match(/```javascript\n([\s\S]*?)\n```/) || text.match(/```js\n([\s\S]*?)\n```/);

        // 2. If HTML exists, we show preview
        if (htmlMatch) {
            let html = htmlMatch[1];
            let css = cssMatch ? cssMatch[1] : '';
            let js = jsMatch ? jsMatch[1] : '';

            // 3. Construct the full document
            const fullDoc = `
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        ${css}
                    </style>
                </head>
                <body>
                    ${html}
                    <script>
                        try {
                            ${js}
                        } catch (e) { console.error(e); }
                    <\/script>
                </body>
                </html>
            `;

            previewArea.style.display = 'flex';
            previewIframe.srcdoc = fullDoc;
        }
    }

    // --- CORE SUBMIT LOGIC ---
    if (promptForm) {
        promptForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = chatInput.value.trim();
            if (!prompt || appState.isLoading) return;

            // 1. UI Updates
            appState.isLoading = true;
            submitButton.disabled = true;
            addMessageToChat('user', prompt);
            const loadingMsgEl = addMessageToChat('assistant', '', true); // Loading state
            chatInput.value = '';
            chatInput.style.height = 'auto';

            try {
                // 2. Backend Call
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });
                const data = await response.json();

                // 3. Handle Response
                if (response.ok) {
                    // Replace loading spinner with rendered MD
                    loadingMsgEl.innerHTML = md.render(data.answer);
                    
                    // Re-highlight code blocks
                    loadingMsgEl.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });

                    // Check for preview code
                    renderPreview(data.answer);
                    
                    // Update credits
                    if (data.remaining && creditBalanceEl) {
                        creditBalanceEl.textContent = parseFloat(data.remaining).toFixed(2);
                    }
                } else {
                    loadingMsgEl.innerHTML = `<span style="color:red;">Error: ${data.error || 'Failed'}</span>`;
                }
            } catch (err) {
                loadingMsgEl.innerHTML = `<span style="color:red;">Network Error</span>`;
            } finally {
                appState.isLoading = false;
                submitButton.disabled = false;
                scrollToBottom();
            }
        });
    }

    function closePreview() {
        previewArea.style.display = 'none';
    }
    
    // Toggle Profile Menu
    if (profileButton) {
        profileButton.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('visible');
        });
        window.addEventListener('click', () => {
            profileDropdown.classList.remove('visible');
        });
    }
    
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
    }
</script>
</body>
</html>